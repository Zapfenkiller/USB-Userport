<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.18"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>USB-Userport: USB-Userport Host-Demo</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="Logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">USB-Userport
   </div>
   <div id="projectbrief">PC-Programme nutzen die generische HID Klasse zur Verbindung mit elektronischen Experimenten.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Erzeugt von Doxygen 1.8.18 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Suchen');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Suchen');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">USB-Userport Host-Demo </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Der USB-Userport ist schön und gut, wird allerdings erst durch ein Programm auf der Host-Seite zum Leben erweckt.</p>
<p>In diesem Fall wird anstelle einer vernünftigen Programmiersprache (z. B. C oder Python) das Basic der Excel-Macros verwendet. Warum? Nun, auf den meisten Windows-PCs ist das Office-Paket auch mit drauf. Damit entfällt die Installation spezieller Compiler oder IDEs. Man kommt ohne Adminrechte aus um seine eigene Elektronik mit dem Computer zu koppeln. Der Preis dafür ist allerdings die unzureichende und stellenweise falsche Dokumentation von µ$.</p>
<p>Als besonderer Nebeneffekt ist es möglich Sensordaten per USB-Userport einzusammeln und mit allen Excel-Möglichkeiten zu bearbeiten. Für die Entwicklung angepasster Algorithmen ist das oft hilfreich.</p>
<p>Allerdings sind Excel-Dateien aus dem Internet möglicherweise von Schadsoftware befallen. Dem wird insofern Rechnung getragen, dass es hier keine Excel-Dateien gibt. Und wie soll das nun funktionieren?</p>
<h1><a class="anchor" id="Sec_Preparation"></a>
Host-Demo Vorbereiten</h1>
<p>Im Fundus der Host-Demo zum USB-Userport gibt es drei Macrodateien die ins Excel, genauer in ein nagelneues Workbook, importiert werden müssen.</p>
<table class="doxtable">
<tr>
<td><b>Module1.bas:</b> </td><td>Workbook vollständig bauen  </td></tr>
<tr>
<td><b>Module2.bas:</b> </td><td>Interface zum Generic HID  </td></tr>
<tr>
<td><b>Module5.bas:</b> </td><td>Demoanwendung für LEDs und GPIOs </td></tr>
</table>
<p>Im <code>Module1</code> findet sich das Macro <code>Build_Workbook</code>. Dieses wird einmal ausgeführt. Das Macro baut alle benötigten Dialogsheets für <code>LEDs</code> und <code>GPIOs</code> sowie das Hauptsheet <code>Main</code> auf. Danach sollte das Workbook unter einem sinnvollen Namen gespeichert werden.</p>
<h1><a class="anchor" id="Sec_Usage"></a>
Host-Demo Benutzen</h1>
<p>Das frisch erzeugte Workbook enthält das Sheet <code>Main</code> mit der minimalen Kontrolle. Zuerst ist der USB-USerport an den Computer anzuschliessen. Danach wird in der Zelle <code>C3</code> ("USB-Userport
 Address:") die Seriennummer des angeschlossenen Gerätes eingestellt. Üblicherweise wird es die '1' sein, das hängt aber von den Optionen ab mit denen die Firmware des USB-Userport gebaut wurde.</p>
<p>Ein Klick auf den <code>Connect</code>-Button startet den Suchvorgang. Wird das Gerät gefunden, so springt der Status auf "Connected" um. Der <code>Connect</code>-Button wird durch den <code>Disconnect</code>-Button ersetzt.</p>
<p>Für den ersten Versuch startet ein Klick auf "Run LED Control" den spartanischen Excel-Dialog zur Kontrolle der beiden Board-LEDs. Ein Klick in die Checkbox schaltet die zugehörige LED an oder aus. Ein Klick auf <code>Done</code> beendet den Dialog.</p>
<p><code>Run GPIO Control</code> startet den grossen Dialog mit dem die Portleitungen manuell gesteuert werden. Links sind die 14 Leitungen des GPIO1, in der Mitte die 4 Leitungen des GPIO2. Und ganz rechts sind die 4 analogen Eingänge zu finden. Dazu gibt es weiter unten mehr.</p>
<p>Je Leitung gibt es drei Checkboxen, davon sind nur zwei per Maus zu bedienen. <code>Set[x]</code> stellt das PORT-Register des Controllers ein. <code>Dir[x]</code> geht 1:1 ins zugehörige DDR-Register. Die Leitungen haben genau die Eigenschaften, die der ATmega32U4 von Hause aus anbietet.</p>
<table class="doxtable">
<tr>
<th>Set[x]  </th><th>Dir[x]  </th><th>Eigenschaft  </th></tr>
<tr>
<td>'0'  </td><td>'0'  </td><td>Eingang  </td></tr>
<tr>
<td>'1'  </td><td>'0'  </td><td>Eingang mit Pull-Up  </td></tr>
<tr>
<td>'0'  </td><td>'1'  </td><td>Ausgang, treibt 0 V  </td></tr>
<tr>
<td>'1'  </td><td>'1'  </td><td>Ausgang, treibt 5 V  </td></tr>
</table>
<p>Die Checkbox <code>Get[x]</code> spiegelt den zurückgelesenen logischen Pegel der Leitung wieder. Die Daten kommen aus dem jeweiligen PIN-Register des Controllers.</p>
<p>Die 4 Leitungen des GPIO2 können auch als analoge Eingänge benutzt werden. Dies lässt sich für jede Leitung einzeln einstellen. Zunächst ist oben in der Dialog-Box die Referenzspannung auszuwählen. Der verwendete ProMicro gestattet die interne Referenzquelle von 2,56 V oder die Betriebsspannung AVcc (die bei USB-Versorgung so etwa 4,7 V beträgt). Diese Auswahl gilt global für alle analogen Eingänge. Sie kann jederzeit umgeschaltet werden.</p>
<p>Die Checkbox <code>DIDR</code> jedes analogen Eingangs gestattet es die digitale Eingangslogik der GPIO-Leitung des µC abzukoppeln. Die Hintergründe sind im Datenblatt erklärt. Die Checkbox <code>Enable</code> konfiguriert den ADC und veranlasst die Abfrage des Analogwertes. Der Meßwert erscheint als vorzeichenlose 16-Bit Zahl. Da der ADC nur 10 Bit auflöst, das Ergebnis jedoch "linksbündig" ausgeliefert wird, stehen die unteren 6 Bits immer auf '0' und die Werte springen in 64er-Stufen. Dies ist so gebaut um höher auflösende ADCs im gleichen Wertebereich zu halten. Eine Anwendung muss dann nicht neu geschrieben oder angepasst werden.</p>
<table class="doxtable">
<tr>
<th>DIDR[x]  </th><th>Enable  </th><th>Eigenschaft  </th></tr>
<tr>
<td>'0'  </td><td>'0'  </td><td>Volle GPIO-Funktion  </td></tr>
<tr>
<td>'1'  </td><td>'0'  </td><td>Nur digitaler Ausgang, kein digitaler Eingang  </td></tr>
<tr>
<td>'0'  </td><td>'1'  </td><td>Volle GPIO-Funktion und analoger Eingang </td></tr>
<tr>
<td>'1'  </td><td>'1'  </td><td>Nur digitaler Ausgang, analoger Eingang  </td></tr>
</table>
<p>Es ist ausdrücklich möglich (und für manche Experimente auch nötig) die analogen Leitungen als Ausgänge zu definieren und die Spannungen der Ausgänge analog zu erfassen. Besonders interessant wird das in Verbindung mit den internen Pull-Ups des GPIO. Daher bleibt die GPIO2-Kontrolle weiterhin freigeschaltet.</p>
<p>Ein Klick auf den <code>Update</code>-Button tauscht jetzt erst die Daten mit dem USB-Userport aus - die Einstellungen für die Ausgänge und Datenrichtungen gehen ans Gerät, die anliegenden logischen Pegel der Leitungen sowie die ausgewählten analogen Eingänge werden vom Gerät abgeholt. Dabei wird zuerst geschrieben, danach gelesen. Auf die Art stimmen die Zustände auch der Ausgänge. Ergibt sich hier ein anderer Ausgangs-Pegel als der, der geschrieben wurde, so liegt ein Kurzschluß vor! Für Eingänge (mit oder ohne Pull-Up) gibt es hier kein Problem. Ein Klick auf <code>Done</code> beendet den Dialog.</p>
<h1><a class="anchor" id="Sec_HID_Connection"></a>
HID-Anbindung</h1>
<p>Die Anbindung des Nutzercodes (hier die Dialoge für LEDs und GPIOs mit ihren Macros in <code>Module5.bas</code>) erfolgt durch die Funktionen aus <code>Module2.bas</code>. Genau diese Routinen sind für eigene Host- Applikationen zu übernehmen. Sie bilden das Gegenstück zu den Definitionen im USB-Userport.</p>
<p>Als ein erster Test für die eigenen Programmierkünste mag ein LED-Blinker herhalten, der eine der LEDs zeitgesteuert ein und ausschaltet. <code>Module3.bas</code> zeigt eine Musterlösung. Die gesammelten Verzögerungstechniken finden sich bei <a href="https://stackoverflow.com/questions/1544526/how-to-pause-for-specific-amount-of-time-excel-vba">Stackoverflow</a>.</p>
<p>Viel Vergnügen! </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Erzeugt am Mon Jun 29 2020 19:35:37 für USB-Userport von
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.18 </li>
  </ul>
</div>
</body>
</html>
